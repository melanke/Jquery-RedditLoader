(function(e){var t=function(t,n){var r;var i;var s;var o;var u=false;var a=0;var f=function(){n=e.extend(t.data(),n);if(!n.render)n.render=S;if(!n.minDelay)n.minDelay=3e3;if(!n.maxImgurAlbumItens)n.maxImgurAlbumItens=5;if(n.skipPage===undefined)n.skipPage=true;r=(n.subreddits||"").split("/");i=[];s=[];o=-1;h()};this.resume=function(){u=false;h()};var l=this.resume;this.pause=function(){u=true};var c=this.pause;var h=function(){if(u)return;if(!r||!r.length||o<0)o=0;else o=(o+1)%r.length;if(i[o]&&i[o].length>0){var e=Math.max(n.minDelay+a-Date.now(),1);a=Date.now();setTimeout(function(){d(i[o][0],function(e){if(e)n.render(i[o][0].data,S);i[o].splice(0,1);h()})},e)}else{var t=null;if(s&&s[o])t=s[o];p(r[o],t,function(e){if(e&&e.length){i[o]=e;s[o]=e[e.length-1].data.name}else{r.splice(o,1);o--}h()})}};var p=function(r,i,s){var o="http://www.reddit.com/";if(r)o+="r/"+r;if(n.redditSort)o+="/"+n.redditSort;o+=".json?jsonp=?";if(i)o+="&after="+i;e(t).trigger("beforeSubredditLoad",[o]);e.getJSON(o,function(n){e(t).trigger("successSubredditLoad",[o]);s(n.data.children)}).error(function(){e(t).trigger("errorSubredditLoad",[o]);s(null)})};var d=function(r,i){e(t).trigger("beforePostLoad",[r.data.url]);var s=r.data.url;var o=function(o){r.data.top3comments=o;if(n.skipNsfw&&r.data.over_18){e(t).trigger("skipPostLoad",[r.data.url,"nsfw"]);i(false);return}if(r.data.selftext_html){if(n.skipText){e(t).trigger("skipPostLoad",[r.data.url,"text"]);i(false)}else{r.data.formated_text=w(r.data.selftext_html);e(t).trigger("successPostLoad",[r.data.url]);i(true)}return}if(n.skipGifs&&s.indexOf(".gif")!=-1){e(t).trigger("skipPostLoad",[r.data.url,"gif"]);i(false);return}if(s.indexOf(".jpeg")!=-1||s.indexOf(".jpg")!=-1||s.indexOf(".png")!=-1||s.indexOf(".gif")!=-1){e("<img />").attr("src",r.data.url).load(function(){e(t).trigger("successPostLoad",[r.data.url]);i(true)}).error(function(){e(t).trigger("errorPostLoad",[r.data.url]);i(false)});return}if(s.indexOf("imgur.com/a/")!=-1){if(n.skipImgurAlbum){e(t).trigger("skipPostLoad",[r.data.url,"imgur"]);i(false)}else{g(r,s,i)}return}if(s.indexOf("imgur")!=-1){m(r,s,i);return}if(s.indexOf("quickmeme")!=-1||s.indexOf("qkme")!=-1){r.data.url="http://i.qkme.me/"+s.replace("http://","").replace("www.","").replace("quickmeme.com/meme/","").replace("qkme.me","").replace("/","").replace(/\?id=.+/,"")+".jpg";e("<img />").attr("src",r.data.url).load(function(){e(t).trigger("successPostLoad",r.data.url);i(true)}).error(function(){e(t).trigger("errorPostLoad",r.data.url);i(false)});return}var u=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/;var a=s.match(u);if(a&&a[2].length==11){if(n.skipYoutube){e(t).trigger("skipPostLoad",[r.data.url,"youtube"]);i(false)}else{r.data.youtube=a[2];i(true);return}}if(n.skipPage){e(t).trigger("skipPostLoad",[r.data.url,"page"]);i(false)}else{r.data.page=true;e(t).trigger("successPostLoad",[r.data.url]);i(true)}};v(r,o)};var v=function(t,r){if(n.skipComment){r([]);return}var i="http://www.reddit.com"+t.data.permalink+".json?sort=top&limit=20&depth=2&jsonp=?";e.getJSON(i,function(t){var n=[];for(var i in t){if(n.length>=3){break}for(var s in t[i].data.children){if(n.length>=3){break}var o=t[i].data.children[s];if(o.kind=="t1"){var u=e("<span />",{html:o.data.body_html}).text();var a=null;if(o.data.replies.data){var f=null;var s=0;do{f=o.data.replies.data.children[s++]}while(f&&f.kind!="t1");if(f&&f.kind=="t1"){a=e("<span />",{html:f.data.body_html}).text()}}n.push({comment:E(u),reply:E(a)})}}}r(n)}).error(function(){r([])})};var m=function(n,r,i){var s=r.split("/");var o=s[s.length-1];var u="http://api.imgur.com/2/image/"+o+".json";e.getJSON(u,function(r){e("<img />").attr("src",r.image.links.original).load(function(){n.data.url=r.image.links.original;e(t).trigger("successPostLoad",[r.image.links.original]);i(true)}).error(function(){e(t).trigger("errorPostLoad",[r.image.links.original]);i(false)})}).error(function(){e(t).trigger("errorPostLoad",[u]);i(false)})};var g=function(r,i,s){var o=i.split("/");var u=o[o.length-1];var a="http://api.imgur.com/2/album/"+u+".json";e.getJSON(a,function(o){r.data.imgur=[];if(n.maxImgurAlbumItens>-1&&n.maxImgurAlbumItens<o.album.images.length){e(t).trigger("skipPostLoad",[i,"imgur max"]);s(false);return}y(r.data.imgur,o.album.images,0,s)}).error(function(){e(t).trigger("errorImgurLoad",[i]);s(false)})};var y=function(e,t,n,r){b(t[n].links.original,function(i){if(i){e.push(t[n].links.original);n++;if(n>t.length-1)r(true);else y(e,t,n,r)}else{r(false)}})};var b=function(n,r){e("<img />").attr("src",n).load(function(){e(t).trigger("successImgurItemLoad",[n]);r(true)}).error(function(){e(t).trigger("errorImgurItemLoad",[n]);r(false)})};var w=function(t){return E(e("<div/>").html(t).text())};var E=function(t){var n=e("<div/>").html(t);n.find("a").each(function(){e(this).attr("target","_blank");var t=e(this).attr("href");if(t.indexOf("http://")===-1){e(this).attr("href","http://reddit.com"+t)}});return n.html()};var S=function(n){if(n.youtube){e(t).append("<h1><span class='subreddit'>"+n.subreddit+"</span>"+n.title+"</h1><iframe type='text/html' width='640' height='390' src='http://www.youtube.com/embed/"+n.youtube+"' frameborder='0'/><hr/>");c();setTimeout(l,6e3)}else if(n.imgur){e(t).append("<h1><span class='subreddit'>"+n.subreddit+"</span>"+n.title+"</h1>");for(var r in n.imgur){e(t).append("<img src='"+n.imgur[r]+"'/><br/>")}e(t).append("<hr/>")}else if(n.formated_text){e(t).append("<h1><span class='subreddit'>"+n.subreddit+"</span>"+n.title+"</h1>"+n.formated_text+"<hr/>")}else if(n.page){e(t).append("<h1><span class='subreddit'>"+n.subreddit+"</span><a href='"+n.url+"' target='_blank'>"+n.title+"</a></h1>")}else{e(t).append("<h1><span class='subreddit'>"+n.subreddit+"</span>"+n.title+"</h1><img src='"+n.url+"'/><hr/>")}for(var r in n.top3comments){var i=n.top3comments[r];e(t).append(i.comment);if(i.reply){e(t).append("<div class='reply'>"+i.reply+"<div>")}}};f()};e.fn.redditloader=function(n){this.each(function(){var r=e(this).data("redditloader");if(!r)r=new t(e(this),n);if(n===true)r.resume();else if(n===false)r.pause();e(this).data("redditloader",r)})}})(jQuery)